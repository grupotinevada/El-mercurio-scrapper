<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Suite de Automatización</title>
  <link rel="icon" type="image/x-icon" href="redes.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    /* --- FLUENT DESIGN SYSTEM TOKENS --- */
    :root {
      --fluent-bg: radial-gradient(circle at top left, #ffffff 60%, #cccccc 100%);
      --fluent-surface: #ffffff;
      --fluent-border: #e5e5e5;
      --fluent-text-primary: #1b1b1b;
      --fluent-text-secondary: #5d5d5d;

      /* Colores Principales */
      --fluent-accent: #0067c0;
      --fluent-accent-hover: #005a9e;
      --macal-orange: #fd7e14;
      --hp-indigo: #6610f2;

      --fluent-radius: 12px;
      /* Más redondeado para estilo Hub */
      --fluent-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --fluent-shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    body {
      background: var(--fluent-bg);
      font-family: 'Segoe UI Variable', 'Segoe UI', system-ui, -apple-system, sans-serif;
      color: var(--fluent-text-primary);
      height: 100vh;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
    }

    /* --- LAYOUT GENERAL --- */
    .app-header {
      padding: 20px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 80px;
    }

    .main-container {
      flex: 1;
      padding: 0 40px 40px 40px;
      position: relative;
      overflow-y: auto;
    }

    /* --- HUB CARDS (ESTILO DE APPS) --- */
    .hub-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-top: 20px;
      animation: fadeIn 0.4s ease-out;
    }

    .hub-card {
      background: var(--fluent-surface);
      border: 1px solid var(--fluent-border);
      border-radius: var(--fluent-radius);
      padding: 30px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
      text-align: left;
      position: relative;
      overflow: hidden;
      height: 220px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .hub-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--fluent-shadow-hover);
      border-color: transparent;
    }

    .hub-card .icon-wrapper {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 16px;
      transition: transform 0.2s;
    }

    .hub-card:hover .icon-wrapper {
      transform: scale(1.1);
    }

    /* Colores específicos de tarjetas */
    .hub-card.mercurio .icon-wrapper {
      background: rgba(0, 103, 192, 0.1);
      color: var(--fluent-accent);
    }

    .hub-card.macal .icon-wrapper {
      background: rgba(253, 126, 20, 0.1);
      color: var(--macal-orange);
    }

    .hub-card.hp .icon-wrapper {
      background: rgba(102, 16, 242, 0.1);
      color: var(--hp-indigo);
    }

    .hub-card.mercurio:hover {
      border-top: 4px solid var(--fluent-accent);
    }

    .hub-card.macal:hover {
      border-top: 4px solid var(--macal-orange);
    }

    .hub-card.hp:hover {
      border-top: 4px solid var(--hp-indigo);
    }

    .card-title {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 8px;
    }

    .card-desc {
      font-size: 0.9rem;
      color: var(--fluent-text-secondary);
      line-height: 1.4;
    }

    .card-arrow {
      position: absolute;
      bottom: 20px;
      right: 20px;
      opacity: 0;
      transform: translateX(-10px);
      transition: all 0.3s;
    }

    .hub-card:hover .card-arrow {
      opacity: 1;
      transform: translateX(0);
    }

    /* --- VISTAS DE LAS APPS --- */
    .view-container {
      display: none;
      /* Oculto por defecto */
      background: var(--fluent-surface);
      border-radius: var(--fluent-radius);
      box-shadow: var(--fluent-shadow);
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
      animation: slideUp 0.3s ease-out;
    }

    .view-header {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--fluent-border);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* Botón Volver */
    .btn-back {
      border: none;
      background: transparent;
      font-weight: 600;
      color: var(--fluent-text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 6px;
      transition: background 0.2s;
      cursor: pointer;
    }

    .btn-back:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--fluent-text-primary);
    }

    /* Animaciones */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* --- FORMULARIOS (Heredados) --- */
    .form-control {
      border: 1px solid var(--fluent-border);
      border-radius: 6px;
      padding: 10px 12px;
    }

    .form-control:focus {
      border-color: var(--fluent-accent);
      box-shadow: 0 0 0 2px rgba(0, 103, 192, 0.1);
    }

    .btn {
      border-radius: 6px;
      padding: 10px 24px;
      font-weight: 500;
    }

    /* Botones Específicos */
    .btn-primary {
      background-color: var(--fluent-accent);
      border-color: var(--fluent-accent);
    }

    .btn-primary:hover {
      background-color: var(--fluent-accent-hover);
    }

    .btn-orange {
      background-color: var(--macal-orange);
      color: white;
      border: none;
    }

    .btn-orange:hover {
      background-color: #e36d0d;
      color: white;
    }

    .btn-indigo {
      background-color: var(--hp-indigo);
      color: white;
      border: none;
    }

    .btn-indigo:hover {
      background-color: #520dc2;
      color: white;
    }

    /* Overlay de Progreso */
    #progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    #progress-percentage {
      font-size: 2rem;
      font-weight: 300;
      color: var(--fluent-text-primary);
      margin-top: 15px;
    }
  </style>
</head>

<body>

  <div class="app-header">
    <div>
      <h4 class="m-0 fw-bold" id="header-title"><i class="bi bi-robot me-2"></i>Extractor Roberto</h4>
      <small class="text-muted" id="header-subtitle">Selecciona una herramienta para comenzar</small>
    </div>
    <button class="btn-back d-none" id="globalBackBtn" onclick="volverAlHub()">
      <i class="bi bi-arrow-left"></i> Volver al Inicio
    </button>
  </div>

  <div class="main-container">

    <div id="hub-view" class="hub-grid">

      <div class="hub-card mercurio" onclick="abrirAplicacion('mercurio')">
        <div>
          <div class="icon-wrapper"><i class="bi bi-newspaper"></i></div>
          <div class="card-title">Extractor El Mercurio</div>
          <div class="card-desc">Procesa remates judiciales desde el visor digital del diario. Santiago y Valparaíso.
          </div>
        </div>
        <div class="card-arrow text-primary"><i class="bi bi-arrow-right-circle-fill fs-4"></i></div>
      </div>

      <div class="hub-card macal" onclick="abrirAplicacion('macal')">
        <div>
          <div class="icon-wrapper"><i class="bi bi-building"></i></div>
          <div class="card-title">Portal Macal</div>
          <div class="card-desc">Extracción automática de propiedades disponibles y generación de reportes Excel.</div>
        </div>
        <div class="card-arrow text-warning"><i class="bi bi-arrow-right-circle-fill fs-4"></i></div>
      </div>

      <div class="hub-card hp" onclick="abrirAplicacion('hp')">
        <div>
          <div class="icon-wrapper"><i class="bi bi-graph-up-arrow"></i></div>
          <div class="card-title">House Pricing</div>
          <div class="card-desc">Tasación masiva y búsqueda de comparables basada en lotes de archivos PDF.</div>
        </div>
        <div class="card-arrow" style="color: var(--hp-indigo);"><i class="bi bi-arrow-right-circle-fill fs-4"></i>
        </div>
      </div>

    </div>

    <div id="view-mercurio" class="view-container">
      <div class="view-header">
        <div class="icon-wrapper bg-light text-primary rounded p-2"><i class="bi bi-newspaper fs-4"></i></div>
        <div>
          <h5 class="m-0 fw-bold">Extractor El Mercurio</h5>
          <small class="text-muted">Configura los parámetros de búsqueda</small>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-12">
          <label for="url" class="form-label">URL del Diario (Visor Papel)</label>
          <input type="text" class="form-control" id="url" placeholder="https://..." required>
        </div>
        <div class="col-md-6">
          <label for="paginas" class="form-label">Páginas a procesar</label>
          <input type="number" class="form-control" id="paginas" placeholder="Ej: 5" required>
        </div>
        <div class="col-md-6">
          <label for="columnas" class="form-label">Columnas (Layout)</label>
          <input type="number" class="form-control" id="columnas" value="7" placeholder="Ej: 7" required>
        </div>
      </div>

      <div class="d-flex gap-3 mt-4 pt-3 border-top">
        <button class="btn btn-primary flex-grow-1" id="submitBtn" onclick="enviar()">
          <i class="bi bi-play-circle-fill me-2"></i>Iniciar Extracción
        </button>
        <button class="btn btn-light border" id="openFolderBtn" onclick="abrirResultados()">
          <i class="bi bi-folder2-open"></i>
        </button>
      </div>
      <p id="status" class="mt-3 text-center small fw-medium text-secondary"></p>
    </div>

    <div id="view-macal" class="view-container">
      <div class="view-header">
        <div class="icon-wrapper bg-light text-warning rounded p-2"><i class="bi bi-building fs-4"></i></div>
        <div>
          <h5 class="m-0 fw-bold">Portal Inmobiliario Macal</h5>
          <small class="text-muted">Extracción web automatizada</small>
        </div>
      </div>

      <div class="text-center py-4">
        <p class="text-secondary px-5 mb-4">
          Este módulo navegará automáticamente por el portal Macal para recopilar la información actualizada de los
          remates.
        </p>
        <div class="d-grid gap-3 col-8 mx-auto">
          <button class="btn btn-orange" id="macalBtn" onclick="ejecutarMacal()">
            <i class="bi bi-rocket-takeoff me-2"></i>Iniciar Proceso Macal
          </button>
          <button class="btn btn-light border" onclick="abrirResultadosMacal()">
            <i class="bi bi-folder-symlink me-2"></i>Abrir Carpeta
          </button>
        </div>
        <p id="macal-status" class="mt-3 text-center small fw-medium text-secondary"></p>
      </div>
    </div>

    <div id="view-hp" class="view-container">
      <div class="view-header">
        <div class="icon-wrapper bg-light rounded p-2" style="color: var(--hp-indigo);"><i
            class="bi bi-graph-up-arrow fs-4"></i></div>
        <div>
          <h5 class="m-0 fw-bold">House Pricing Lote</h5>
          <small class="text-muted">Procesamiento masivo de PDFs</small>
        </div>
      </div>

      <div class="text-center py-3">
        <div class="p-4 border border-dashed rounded bg-light mb-4">
          <i class="bi bi-file-earmark-pdf fs-1 text-secondary"></i>
          <p class="mb-3 mt-2 text-muted small">Carga tus informes de antecedentes (PDF) aquí.</p>

          <button class="btn btn-outline-primary btn-sm" onclick="seleccionarArchivosHP()">
            <i class="bi bi-plus-lg me-1"></i> Seleccionar Archivos
          </button>
          <div class="mt-2">
            <small id="hp-file-count" class="text-primary fw-bold">Ningún archivo seleccionado</small>
          </div>
        </div>

        <div class="d-flex gap-3 justify-content-center">
          <button class="btn btn-indigo px-5" id="hpBtn" onclick="ejecutarHP()" disabled>
            <i class="bi bi-gear-wide-connected me-2"></i>Procesar Todo
          </button>
          <button class="btn btn-light border" onclick="abrirResultadosHP()">
            <i class="bi bi-folder2-open"></i>
          </button>
        </div>
        <p id="hp-status" class="mt-3 text-center small fw-medium text-secondary"></p>
      </div>
    </div>

  </div>

  <div id="progress-overlay">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <div id="progress-percentage">0%</div>
    <div id="progress-message" class="text-secondary small fw-bold">Iniciando...</div>
    <button class="btn btn-sm btn-outline-danger mt-4 px-4 rounded-pill" onclick="cancelarProceso()">
      Cancelar Operación
    </button>
  </div>

  <script>
    // --- LÓGICA DE NAVEGACIÓN TIPO HUB ---
    const hubView = document.getElementById('hub-view');
    const backBtn = document.getElementById('globalBackBtn');
    const headerTitle = document.getElementById('header-title');
    const headerSubtitle = document.getElementById('header-subtitle');

    function abrirAplicacion(appId) {
      // 1. Ocultar Hub
      hubView.style.display = 'none';

      // 2. Mostrar Botón Volver
      backBtn.classList.remove('d-none');

      // 3. Ocultar todas las vistas primero
      document.querySelectorAll('.view-container').forEach(el => el.style.display = 'none');

      // 4. Mostrar la vista específica y actualizar textos
      if (appId === 'mercurio') {
        document.getElementById('view-mercurio').style.display = 'block';
        headerTitle.innerText = "El Mercurio";
        headerSubtitle.innerText = "Módulo de extracción prensa";
      } else if (appId === 'macal') {
        document.getElementById('view-macal').style.display = 'block';
        headerTitle.innerText = "Macal";
        headerSubtitle.innerText = "Portal de remates online";
      } else if (appId === 'hp') {
        document.getElementById('view-hp').style.display = 'block';
        headerTitle.innerText = "House Pricing";
        headerSubtitle.innerText = "Análisis de mercado masivo";
      }
    }

    function volverAlHub() {
      // 1. Ocultar vistas
      document.querySelectorAll('.view-container').forEach(el => el.style.display = 'none');

      // 2. Mostrar Hub
      hubView.style.display = 'grid'; // Grid layout para el hub

      // 3. Resetear Header
      headerTitle.innerText = "Automation Hub";
      headerSubtitle.innerText = "Selecciona una herramienta para comenzar";
      backBtn.classList.add('d-none');
    }

    // --- LÓGICA EXISTENTE DE MERCURIO ---
    const urlInput = document.getElementById('url');
    const colInput = document.getElementById('columnas');

    urlInput.addEventListener('input', function () {
      const val = this.value.toLowerCase();
      if (val.includes('mercuriovalpo.cl')) {
        colInput.value = 7;
        colInput.disabled = true;
      } else {
        colInput.disabled = false;
      }
    });

    let currentPercentage = 0;
    let targetPercentage = 0;
    let progressInterval = null;

    function actualizarMensajeUI(msg, tipo = 'info') {
      const statusElement = document.getElementById('status');
      statusElement.textContent = msg;
      let clase = 'mt-3 text-center fw-bold text-dark';
      if (tipo === 'success') clase = 'mt-3 text-center fw-bold text-success';
      else if (tipo === 'error') clase = 'mt-3 text-center fw-bold text-danger';
      else if (tipo === 'warning') clase = 'mt-3 text-center fw-bold text-warning';
      statusElement.className = clase;
    }

    async function enviar() {
      const submitButton = document.getElementById('submitBtn');
      const data = {
        url: document.getElementById('url').value,
        paginas: document.getElementById('paginas').value,
        columnas: document.getElementById('columnas').value,
      };

      bloquearUI();
      actualizarMensajeUI('Iniciando proceso...');
      actualizarProgreso(0, 'Validando datos...');

      try {
        const response = await window.pywebview.api.procesar_formulario(data);
        if (!response.success) {
          actualizarMensajeUI(response.message, 'error');
          ocultarProgreso();
          document.getElementById('submitBtn').disabled = false;
        }
      } catch (e) {
        actualizarMensajeUI('Error de comunicación con el backend.', 'error');
        ocultarProgreso();
        document.getElementById('submitBtn').disabled = false;
        console.error(e);
      }
    }

    async function abrirResultados() {
      try {
        const response = await window.pywebview.api.abrir_carpeta();
        if (!response.success) actualizarMensajeUI(response.message, 'error');
      } catch (e) {
        console.error(e);
      }
    }

    async function cancelarProceso() {
      const msgEl = document.getElementById('progress-message');
      if (msgEl) msgEl.innerText = "Cancelando...";
      await window.pywebview.api.cancelar_proceso();
    }

    function actualizarProgreso(porcentaje, mensaje) {
      const overlay = document.getElementById('progress-overlay');
      const percentageEl = document.getElementById('progress-percentage');
      const messageEl = document.getElementById('progress-message');

      overlay.style.display = 'flex';
      messageEl.textContent = mensaje;
      targetPercentage = porcentaje;

      if (progressInterval) clearInterval(progressInterval);

      if (currentPercentage < targetPercentage) {
        progressInterval = setInterval(() => {
          if (currentPercentage < targetPercentage) {
            currentPercentage++;
            percentageEl.textContent = `${Math.round(currentPercentage)}%`;
          } else {
            clearInterval(progressInterval);
            progressInterval = null;
          }
        }, 15);
      }
    }

    function ocultarProgreso() {
      const overlay = document.getElementById('progress-overlay');
      overlay.style.display = 'none';
      if (progressInterval) clearInterval(progressInterval);
      currentPercentage = 0;
      targetPercentage = 0;
    }

    // --- LÓGICA MACAL ---
    async function ejecutarMacal() {
      const macalButton = document.getElementById('macalBtn');
      macalButton.disabled = true;
      actualizarMacalStatus('Iniciando proceso Macal...', 'info');
      actualizarProgreso(0, 'Iniciando extracción de Macal...');
      try {
        const response = await window.pywebview.api.ejecutar_macal();
        if (!response.success) finalizarProcesoMacal(response.message, 'error');
      } catch (e) {
        finalizarProcesoMacal('Error de comunicación.', 'error');
        console.error(e);
      }
    }

    function actualizarMacalStatus(msg, tipo = 'info') {
      const statusElement = document.getElementById('macal-status');
      statusElement.textContent = msg;
      let clase = 'mt-3 text-center fw-bold text-dark';
      if (tipo === 'success') clase = 'mt-3 text-center fw-bold text-success';
      else if (tipo === 'error') clase = 'mt-3 text-center fw-bold text-danger';
      statusElement.className = clase;
    }

    function finalizarProcesoMacal(msg, tipo = 'info') {
      actualizarMacalStatus(msg, tipo);
      document.getElementById('macalBtn').disabled = false;
      ocultarProgreso();
    }

    async function abrirResultadosMacal() {
      try {
        await window.pywebview.api.abrir_carpeta_macal();
      } catch (e) { console.error(e); }
    }

    // --- LÓGICA HOUSE PRICING ---
    async function seleccionarArchivosHP() {
      try {
        const response = await window.pywebview.api.seleccionar_archivos_hp();
        if (response.success) {
          const count = response.count;
          const label = document.getElementById('hp-file-count');
          const btn = document.getElementById('hpBtn');

          if (count > 0) {
            label.textContent = `${count} archivos listos.`;
            label.className = "text-success fw-bold";
            btn.disabled = false;
            actualizarHPStatus('Archivos cargados.', 'info');
          } else {
            label.textContent = "Ningún archivo seleccionado.";
            label.className = "text-muted fw-bold";
            btn.disabled = true;
          }
        }
      } catch (e) {
        console.error(e);
        actualizarHPStatus('Error al seleccionar archivos.', 'error');
      }
    }

    async function ejecutarHP() {
      const btn = document.getElementById('hpBtn');
      btn.disabled = true;
      actualizarHPStatus('Procesando...', 'info');
      actualizarProgreso(0, "Arrancando motor HP...");

      try {
        const response = await window.pywebview.api.ejecutar_house_pricing();
        if (!response.success) {
          actualizarHPStatus(response.message, 'error');
          finalizarProcesoHP();
        }
      } catch (e) {
        actualizarHPStatus('Error crítico.', 'error');
        console.error(e);
        finalizarProcesoHP();
      }
    }

    function actualizarHPStatus(msg, tipo = 'info') {
      const el = document.getElementById('hp-status');
      el.textContent = msg;
      let clase = 'mt-3 text-center fw-bold text-dark';
      if (tipo === 'success') clase = 'mt-3 text-center fw-bold text-success';
      else if (tipo === 'error') clase = 'mt-3 text-center fw-bold text-danger';
      el.className = clase;
    }

    function finalizarProcesoHP() {
      document.getElementById('hpBtn').disabled = false;
      ocultarProgreso();
    }

    async function abrirResultadosHP() {
      try {
        await window.pywebview.api.abrir_carpeta_hp();
      } catch (e) { console.error(e); }
    }

    function bloquearUI() {
      const btn = document.getElementById('submitBtn');
      if (btn) btn.disabled = true;
    }

    function habilitarUI() {
      const btn = document.getElementById('submitBtn');
      if (btn) btn.disabled = false;
    }




  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>